#!/usr/bin/env php
<?php

use Tivins\LSP\LiskovSubstitutionPrincipleChecker;
use Tivins\LSP\ThrowsDetector;
use Tivins\Process\ClassFinder;
use Tivins\Process\FormatType;
use Tivins\Process\StdWriter;

# We are in vendor/bin/lsp-checker, so we need to load the autoload.php from the root project
$autoload = __dir__ . '/../vendor/autoload.php';
require $autoload;

// --- CLI options -----------------------------------------------------------

$format = FormatType::TEXT;
if (in_array('--json', $argv)) {
    $format = FormatType::JSON;
}
$verbose = !in_array('--quiet', $argv);

// First non-option argument = directory to scan.
$directory = null;
foreach (array_slice($argv, 1) as $arg) {
    if (!str_starts_with($arg, '--')) {
        $directory = $arg;
        break;
    }
}

if ($directory === null) {
    fwrite(STDERR, "Usage: lsp-checker <directory> [--json] [--quiet]\n");
    fwrite(STDERR, "  <directory>  Path to a directory containing PHP files to check.\n");
    fwrite(STDERR, "  --json       Output violations as JSON.\n");
    fwrite(STDERR, "  --quiet      Minimal output.\n");
    fwrite(STDERR, "\nRun unit tests with: vendor/bin/phpunit\n");
    exit(2);
}

if (!is_dir($directory)) {
    fwrite(STDERR, "Error: '$directory' is not a valid directory.\n");
    exit(2);
}

$finder  = new ClassFinder();
$classes = $finder->findClassesInDirectory($directory);
if (empty($classes)) {
    fwrite(STDERR, "No PHP classes found in '$directory'.\n");
    exit(0);
}

$writer = new StdWriter($verbose, $format);
$checker = new LiskovSubstitutionPrincipleChecker(new ThrowsDetector());
$writer->message("Checking Liskov Substitution Principle...", "\n\n");

$totalViolations = 0;
$failedClasses = 0;
$allViolations = [];

foreach ($classes as $class) {

    try {
        $violations = $checker->check($class);
        $ok = count($violations) === 0;
    } catch (ReflectionException $e) {
        $ok = false;
        $violations[$class] = $e->getMessage();
    }

    $writer->content(($ok ? "[PASS]" : "[FAIL]") . " $class", FormatType::TEXT);

    if (!$ok) {
        $failedClasses++;
        $totalViolations += count($violations);
        $allViolations = array_merge($allViolations, $violations);
        foreach ($violations as $violation) {
            $writer->content("       -> $violation", FormatType::TEXT);
        }
    }
}

$writer->message("");
$writer->message("Classes checked: " . count($classes));
$writer->message("Passed: " . (count($classes) - $failedClasses) . " / " . count($classes));
$writer->message("Total violations: $totalViolations");

$writer->content(json_encode($allViolations, JSON_PRETTY_PRINT), FormatType::JSON);

// Exit with code 1 if there were any failures, 0 otherwise.
exit($failedClasses > 0 ? 1 : 0);
