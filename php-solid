#!/usr/bin/env php
<?php

declare(strict_types=1);

use Tivins\Solid\Cli\Application;
use Tivins\Solid\Cli\CliParseException;
use Tivins\Solid\Cli\CliParser;
use Tivins\Solid\Process\ClassFinder;
use Tivins\Solid\Process\FormatType;
use Tivins\Solid\Process\StdWriter;

$autoload = '../autoload.php';
if (!is_file($autoload)) {
    throw new Exception("\"vendor/autoload.php\" not found ($autoload). Run via vendor/bin/php-solid from your project root after composer require tivins/php-solid.");
}
require $autoload;

try {
    $options = (new CliParser())->parse($argv);
} catch (CliParseException $e) {
    fwrite(STDERR, $e->getMessage() . "\n");
    exit(2);
}

$finder = new ClassFinder();
$classes = $finder->findClassesFromConfig($options->config);
if ($classes === []) {
    fwrite(STDERR, "No PHP classes found for the given config.\n");
    exit(0);
}

$writer = new StdWriter($options->verbose, $options->format);
$result = (new Application())->run($options, $writer);
$writer->content(
    json_encode($result->toJsonReport(), JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES),
    FormatType::JSON,
);
exit($result->getFailedCount() > 0 ? 1 : 0);
